import{L as A,E as D,i as B,b as L,Q as G,c as O,d as K,F as Q,a as W,G as H}from"./element-plus-DEgQ78-a.js";import{_ as X}from"./ImageConfig-C7ysa23g.js";import{_ as q}from"./Image-CtzcM27r.js";import{K as T,B as J,v as Y,n as R,_ as Z,l as ee,A as te,d as oe}from"./index-CYWUNeU5.js";import{d as j,i as z,m as N,k as ae,o as y,M as V,O as u,a as c,W as r,U as S,u as l,c as I,S as x,Q as le,a3 as se,T as C,P as ie,X as ne,j as re,bn as de,bl as pe}from"./@vue-AVcRlItG.js";import{d as ce}from"./vuedraggable-_x2mUiqy.js";import{_ as ue}from"./CommonSelect-BPJDZPOW.js";import"./lodash-es-25cZ6aDd.js";import"./async-validator-DKvM95Vc.js";import"./dayjs-D7ajE0Qg.js";import"./clipboard-CJr-i2j9.js";import"./@element-plus-Bh_lnI-E.js";import"./@ctrl-r5W6hzzQ.js";import"./@popperjs-D9SI2xQl.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./InputUpload.vue_vue_type_style_index_0_lang-B-6SKlPI.js";import"./@vueuse-80B0Z04t.js";import"./pinia-DsZbUfLd.js";import"./pinia-plugin-persistedstate-n2tMOXAx.js";import"./axios-BdQ6k-vz.js";import"./nprogress-Dnjw-PvA.js";import"./vue-router-MJGgZ6ro.js";import"./markdown-it-4Tp5vWU9.js";import"./mdurl-k9Sl0PQj.js";import"./uc.micro-XL2UFyD4.js";import"./entities-C20TfXL6.js";import"./linkify-it-BpOB9kmn.js";import"./punycode.js-Dj65hjkv.js";import"./crypto-js-BOfVfFwP.js";import"./vue3-danmaku-DA_6354Q.js";import"./plyr-DMguYs3u.js";import"./viewerjs-ul8fLQ7-.js";import"./highlight.js-DnQT8WiG.js";import"./@unhead-CE7b8z0V.js";import"./unhead-BIJBGSS1.js";import"./hookable-B8xFkYCm.js";import"./vue-DnNucVRa.js";const me=c("h4",null,"上传照片",-1),fe={class:"center upload-tip"},_e={class:"fs-12 light-text mt-1"},ge={key:0,class:"fs-12 light-text mt5"},he=["accept"],ve={class:"flex-sb flex-wrap g-2 mt-1"},ye={class:"files-info flex flex-wrap g-1"},be={class:"flex"},we={class:"br-5 layout-100 pr no-select img-wrap"},Ee={class:"layout-card wh-100"},ke={key:0,class:"overlay flex-center"},De={key:1,class:"flex-center img-edit-wrap"},Se={class:"flex-yc g-2"},xe=["onClick"],Ce=["onClick"],Fe=j({__name:"CreateImage",props:{tags:{},group:{},accept:{},path:{},device:{},maxSize:{},concurCount:{},groupOption:{}},setup(b){const p=b,f=z(),w=z(),h=z(!1),m=z(!1),t=N({finish:!1,loading:!1,stop:!1,concur_count:3,upload_index:0,upload_list:[],current_edit:null}),v=ae(()=>{var o;let e=0;for(const a of t.upload_list)e+=((o=a.file)==null?void 0:o.size)||0;return T(e)}),s={handleUpload:async()=>{if(!p.group)return D.warning("请先选择所属相册");t.loading=!0,t.stop=!1;let e=0;t.upload_index=0;async function o(){if(!t.stop){e++;try{await s.uploadFile(e-1)}finally{t.upload_index=t.upload_index+1,t.upload_index===t.upload_list.length&&(t.loading=!1,t.finish=!0,t.upload_list=t.upload_list.filter(a=>a.status!=="success")),e<t.upload_list.length&&o()}}}o()},uploadFile:async e=>{var a,i,d,_,F;const o=(a=t.upload_list[e])==null?void 0:a.file;if(((i=t.upload_list[e])==null?void 0:i.status)!=="success"&&o)try{let E=0,M="";if(!t.upload_list[e].form.image){const g=await J.upload(o,p.path,void 0,k=>{s.handleProgress(e,k)});E=g.code,g.code===200&&(M=g.data.path)}if(E===200||t.upload_list[e].form.image){t.upload_list[e].form.image=M;const g=t.upload_list[e].form;g.tags=(d=g.tags_arr)!=null&&d.length?`|${g.tags_arr.join("|")}|`:"";const k=await Y.save(g);k.code!==200?(R(k,void 0,`照片${(_=t.upload_list[e].file)==null?void 0:_.name}上传成功，但保存失败`),t.upload_list[e].status="fail"):(D.success(`创建照片${t.upload_list[e].form.title||""}成功`),t.upload_list[e].status="success")}else t.upload_list[e].status="fail"}catch(E){console.error((F=t.upload_list[e].file)==null?void 0:F.name,E),t.upload_list[e].status="fail"}},handleStop:()=>{t.stop=!0,t.loading=!1},handleRemove:e=>{const o=t.upload_list.findIndex(a=>a===e);o!==-1&&t.upload_list.splice(o,1)},handleEdit:e=>{m.value=!0,t.current_edit=e.form},handleSelectUpload:()=>{if(!p.group)return D.warning("请先选择所属相册");w.value&&w.value.click()},handleProgress:(e,o)=>{const a=parseInt(o.progress?`${(o.progress*100).toString().substring(0,5)}`:"0");t.upload_list[e].progress=a||0},handleFileSelect:e=>{if(!p.group)return D.warning("请先选择所属相册");const o=e.target,a=o.files;if(a&&a.length>0)for(let i=0;i<a.length;i++){const d=a[i];s.handleFilterFile(d)}o.value=""},handleDrop:async e=>{var a;if(e.preventDefault(),h.value=!1,!p.group)return D.warning("请先选择所属相册");const o=(a=e.dataTransfer)==null?void 0:a.items;if(o)try{for(const i of o)if(i.kind==="file"){const d=i.webkitGetAsEntry();if(!d)continue;d.isFile?s.handleFileEntry(d):d.isDirectory&&s.handleDirectoryEntry(d)}}catch(i){console.error("文件选择出错",i)}},handleDragEnter:e=>{e.preventDefault(),h.value=!0},handleDragLeave:e=>{e.preventDefault(),h.value=!1},handleFilterFile:e=>{var a,i;if(e.size>(p.maxSize||5*1024*1024))return;const o=`.${(a=e==null?void 0:e.type.split("/").pop())==null?void 0:a.toLowerCase()}`;if(o&&((i=p.accept)!=null&&i.includes(o))){t.finish&&(t.finish=!1);const d=e.name.split(".")[0],_=d.length>32?d.substring(0,32):d;t.upload_list.push({file:e,progress:0,url:URL.createObjectURL(e),form:{tags_arr:p.tags||[],group:p.group||void 0,title:_,json:{size:e.size,type:e.type,device:p.device||""}}})}},handleFileEntry:async e=>new Promise((o,a)=>{e.file(i=>{s.handleFilterFile(i),o()},a)}),handleDirectoryEntry:async e=>new Promise((o,a)=>{e.createReader().readEntries(async d=>{for(const _ of d)_.isFile?await s.handleFileEntry(_):_.isDirectory&&await s.handleDirectoryEntry(_);o()},a)})};return(e,o)=>{const a=Z,i=B,d=L,_=q,F=G,E=O,M=X,g=K,k=A;return y(),V(k,{class:"box-card cus-box-card create-image-wrapper w-100",shadow:"never"},{header:u(()=>[me]),default:u(()=>{var U,$;return[c("div",{class:le(["drop-upload-wrap br-5 trf curp p-4 flex-center no-select pr",{draging:l(h)}]),ref_key:"uploadRef",ref:f,onDragover:o[1]||(o[1]=se(()=>{},["prevent"])),onDragenter:o[2]||(o[2]=(...n)=>s.handleDragEnter&&s.handleDragEnter(...n)),onDragleave:o[3]||(o[3]=(...n)=>s.handleDragLeave&&s.handleDragLeave(...n)),onDrop:o[4]||(o[4]=(...n)=>s.handleDrop&&s.handleDrop(...n)),onClick:o[5]||(o[5]=(...n)=>s.handleSelectUpload&&s.handleSelectUpload(...n))},[c("div",fe,[r(a,{name:"upload-cloud-fill",color:"var(--text-color)",size:"50"}),c("div",_e," 拖拽文件或文件夹到此处(限"+S(l(T)(e.maxSize||5*1024*1024))+") ",1),e.accept&&e.accept.length?(y(),I("div",ge," 支持的文件类型: "+S((U=e.accept)==null?void 0:U.join("/")),1)):x("",!0)]),c("input",{multiple:"",type:"file",ref_key:"inputRef",ref:w,class:"input-file curp",accept:($=e.accept)==null?void 0:$.join(","),onChange:o[0]||(o[0]=(...n)=>s.handleFileSelect&&s.handleFileSelect(...n))},null,40,he)],34),c("div",ve,[c("div",ye,[r(i,{type:"primary",plain:""},{default:u(()=>[C("文件总数 "+S(l(t).upload_list.length),1)]),_:1}),r(i,{type:"info",plain:""},{default:u(()=>[C("总大小 "+S(l(v)),1)]),_:1})]),c("div",be,[r(d,{type:"primary",size:"small",loading:l(t).loading,disabled:l(t).upload_list.length===0||l(t).finish,onClick:s.handleUpload},{default:u(()=>[C(S(l(t).finish?"上传结束":l(t).loading?"上传中":"开始上传"),1)]),_:1},8,["loading","disabled","onClick"]),r(d,{type:"danger",size:"small",disabled:!l(t).loading,onClick:s.handleStop},{default:u(()=>[C("停止上传")]),_:1},8,["disabled","onClick"]),r(d,{type:"warning",size:"small",disabled:!l(t).finish,onClick:s.handleUpload},{default:u(()=>[C("重试")]),_:1},8,["disabled","onClick"])])]),l(t).upload_list.length?(y(),V(E,{key:0,"max-height":500,class:"mt-2"},{default:u(()=>[r(l(ce),{modelValue:l(t).upload_list,"onUpdate:modelValue":o[6]||(o[6]=n=>l(t).upload_list=n),"item-key":"id",animation:300,class:"upload-image-grid g-4 p-2 br-5"},{item:u(({element:n})=>[c("div",we,[c("div",Ee,[r(_,{class:"wh-100 br-5",src:n.url},null,8,["src"]),n.status!=="success"?(y(),I("div",ke,[ie(r(F,{type:"circle","striped-flow":"",width:70,"stroke-width":5,percentage:n.progress||0},null,8,["percentage"]),[[ne,l(t).loading]])])):x("",!0),l(t).loading?x("",!0):(y(),I("div",De,[c("div",Se,[c("div",{class:"edit-btn br-50 flex-center curp",onClick:P=>s.handleEdit(n)},[r(a,{name:"edit-box-fill",color:"#fff",size:"12"})],8,xe),c("div",{class:"remove-btn br-50 flex-center curp",onClick:P=>s.handleRemove(n)},[r(a,{name:"close-line",color:"#fff",size:"12"})],8,Ce)])]))])])]),_:1},8,["modelValue"])]),_:1})):x("",!0),l(t).current_edit?(y(),V(g,{key:1,draggable:"",modelValue:l(m),"onUpdate:modelValue":o[8]||(o[8]=n=>re(m)?m.value=n:null),width:"95%",title:"编辑照片"},{default:u(()=>[r(M,{form:l(t).current_edit,"onUpdate:form":o[7]||(o[7]=n=>l(t).current_edit=n)},null,8,["form"])]),_:1},8,["modelValue"])):x("",!0)]}),_:1})}}}),Me=b=>(de("data-v-ce6085d5"),b=b(),pe(),b),ze={class:"admin-album-page-wrapper"},Ie=Me(()=>c("div",{class:"flex-yc flex-sb flex-wrap g-2 pr"},[c("h4",null,"照片批量配置")],-1)),Ve={class:"album-config-form"},Ue=j({__name:"create",setup(b){const p=ee(),f=N({commModel:{group:void 0,tags:[],device:""}}),w={initData:()=>{p.getAlbumGroup(),p.getAlbumTags()},handleTags:h=>{h&&h.length&&h.forEach(async(m,t)=>{var v,s;if(typeof m=="string"){const{code:e,msg:o,data:a}=await te.save({name:m,type:"album",description:"发布相册创建的标签"});if(e!==200)return R(e,void 0,"添加标签失败："+o),(v=p.albumTags)==null?void 0:v.splice(t,1);f.commModel.tags[t]=a.id,(s=p.albumTags)==null||s.push({id:a.id,name:m})}})}};return w.initData(),(h,m)=>{const t=ue,v=Q,s=W,e=H,o=A,a=Fe;return y(),I("div",ze,[r(o,{class:"album-config-card mb-2 w-100 box-card cus-box-card",shadow:"never"},{header:u(()=>[Ie]),default:u(()=>[r(e,{"label-position":"top",class:"w-100"},{default:u(()=>[c("div",Ve,[r(v,{label:"所属相册"},{default:u(()=>[r(t,{modelValue:l(f).commModel.group,"onUpdate:modelValue":m[0]||(m[0]=i=>l(f).commModel.group=i),"label-key":"name","value-key":"id",placeholder:"请选择相册",class:"w-100",options:l(p).albumGroup||[]},null,8,["modelValue","options"])]),_:1}),r(v,{label:"照片标签"},{default:u(()=>[r(t,{class:"w-100",valueKey:"id",labelKey:"name",multiple:"","allow-create":"",filterable:"","reserve-keyword":!1,options:l(p).albumTags||[],value:l(f).commModel.tags,"onUpdate:value":m[1]||(m[1]=i=>l(f).commModel.tags=i),placeholder:"设置照片标签",onChange:w.handleTags},null,8,["options","value","onChange"])]),_:1}),r(v,{label:"拍摄设备"},{default:u(()=>[r(s,{modelValue:l(f).commModel.device,"onUpdate:modelValue":m[2]||(m[2]=i=>l(f).commModel.device=i),placeholder:"请输入拍摄设备"},null,8,["modelValue"])]),_:1})])]),_:1})]),_:1}),r(a,{title:"上传照片",group:l(f).commModel.group,tags:l(f).commModel.tags,device:l(f).commModel.device,path:`${l(p).env.INIS_APP_THEME_NAME}/album/${new Date().toISOString().split("T")[0]}`,"max-size":10*1024*1024,accept:[".png",".jpg",".jpeg",".svg+xml",".bmp",".webp",".gif",".svg"]},null,8,["group","tags","device","path","accept"])])}}}),ht=oe(Ue,[["__scopeId","data-v-ce6085d5"]]);export{ht as default};
